package com.example.vitalsignscheckup;

import androidx.annotation.RequiresApi;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.Toolbar;

import android.content.Intent;
import android.app.Activity;
import android.content.Intent;
import android.os.Build;
import android.os.Bundle;
import android.view.MenuItem;
import android.view.View;
import android.widget.TextView;
import android.widget.Toast;


import org.w3c.dom.Text;

import java.text.DateFormat;
import java.text.DecimalFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.util.HashMap;
import java.util.List;
import java.util.Objects;

@RequiresApi(api = Build.VERSION_CODES.N)
public class MonitorHeartRate extends AppCompatActivity {


    int count = 0;


    DateFormat dateFormat = new SimpleDateFormat("HH:mm:ss");
    Date date = new Date();
    String dateformatted = dateFormat.format(date);
    String histroy_log;




    int i, j;
    double sum, minVal, maxVal;
    int minEle, maxEle;
    int n;

    DecimalFormat df = new DecimalFormat("#0.000");

    ArrayList<Double> data = new ArrayList<Double>(Arrays.<Double>asList(
            -0.0054399999999999995, -0.00611, -0.00683, -0.00719, -0.00746, -0.00732, -0.00629, -0.00566, -0.0050799999999999994, -0.0043100000000000005, -0.0044, -0.00566, -0.00557, -0.00611, -0.00701, -0.007909999999999999, -0.00889, -0.00952, -0.00997, -0.01024, -0.01029, -0.01141, -0.012709999999999999, -0.01294, -0.0124, -0.01213, -0.01123, -0.01078, -0.00988, -0.00889, -0.00827, -0.00809, -0.00732, -0.00755, -0.006959999999999999, -0.00687, -0.00656, -0.00683, -0.00584, -0.00494, -0.00449, -0.00503, -0.00611, -0.00588, -0.00548, -0.00557, -0.00548, -0.00584, -0.00701, -0.00665, -0.00719, -0.007370000000000001, -0.00674, -0.00782, -0.00818, -0.007679999999999999, -0.00773, -0.00683, -0.00629, -0.0062, -0.00647, -0.00665, -0.00701, -0.007370000000000001, -0.00755, -0.00701, -0.007679999999999999, -0.00719, -0.00777, -0.00773, -0.00777, -0.00872, -0.00916, -0.00898, -0.01006, -0.010740000000000001, -0.01141, -0.012490000000000001, -0.013430000000000001, -0.01402, -0.01294, -0.0115, -0.00916, -0.00746, -0.007370000000000001, -0.00665, -0.007909999999999999, -0.00916, -0.00975, -0.01096, -0.01312, -0.013519999999999999, -0.01379, -0.012759999999999999, -0.01096, -0.00975, -0.00925, -0.007909999999999999, -0.00571, -0.0017100000000000001, 0.00252, 0.00647, 0.01078, 0.014819999999999998, 0.0168, 0.01896, 0.02093, 0.02174, 0.02264, 0.02291, 0.02264, 0.022369999999999998, 0.02228, 0.02192, 0.0212, 0.02048, 0.02022, 0.020309999999999998, 0.02044, 0.02102, 0.0221, 0.02358, 0.0248, 0.02543, 0.02731, 0.028569999999999998, 0.03046, 0.03145, 0.03234, 0.03279, 0.03315, 0.03207, 0.030680000000000002, 0.03023, 0.031, 0.029289999999999997, 0.027219999999999998, 0.024480000000000002, 0.02242, 0.01959, 0.017519999999999997, 0.01599, 0.015090000000000001, 0.01348, 0.0124, 0.01047, 0.00863, 0.00692, 0.0037700000000000003, 0.00216, 0.0013, 0.00036, 0.00072, 0.00117, 0.00162, 0.0018, 0.0026100000000000003, 0.00323, 0.0033200000000000005, 0.00216, 0.0009, 0.00072, 0.00054, 0.00031, -0.00036, -0.00126, -0.00234, -0.0015300000000000001, -0.00126, -0.00085, -0.00063, -9e-05, 0.00031, 0.0009, 0.00072, 0.00198, 0.00252, 0.00288, 0.00198, 0.00126, 0.00018, 0.00108, 0.00162, 0.00144, 0.00072, 0.00081, 0.00162, 0.00225, 0.0036799999999999997, 0.0044, 0.0043100000000000005, 0.00503, 0.0046700000000000005, 0.00413, 0.00359, 0.00337, 0.00323, 0.0016600000000000002, 0.0009, 0.00018, -0.00117, -0.00135, -0.00117, -0.00085, -0.00144, -0.00108, -0.00135, -0.00216, -0.00247, -0.00337, -0.0043100000000000005, -0.00611, -0.0088, -0.01141, -0.016980000000000002, -0.02462, -0.03455, -0.04627, -0.0611, -0.07691, -0.09344, -0.10898, -0.12372000000000001, -0.13746, -0.14892, -0.15575, -0.15759, -0.15579, -0.15072, -0.14236, -0.12807000000000002, -0.10683, -0.0814, -0.05301, -0.026060000000000003, 0.0018, 0.02947, 0.0584, 0.09038, 0.12947, 0.17394, 0.22524, 0.28553, 0.35435, 0.42801999999999996, 0.50421, 0.57501, 0.6292800000000001, 0.66782, 0.6932, 0.70116, 0.6884, 0.65767, 0.61311, 0.55561, 0.48966000000000004, 0.41922, 0.34914, 0.28625, 0.23198000000000002, 0.18499000000000002, 0.14662999999999998, 0.11734000000000001, 0.09721, 0.08544, 0.07745, 0.07152, 0.06649, 0.061270000000000005, 0.05542999999999999, 0.051210000000000006, 0.04816, 0.04501, 0.03863, 0.03082, 0.02174, 0.01384, 0.00692, 0.00027, -0.00674, -0.01375, -0.01905, -0.022690000000000002, -0.026410000000000003, -0.02947, -0.03199, -0.03392, -0.03657, -0.037469999999999996, -0.03818, -0.03872, -0.04025, -0.04115, -0.04187, -0.0434, -0.04492, -0.045689999999999995, -0.04609, -0.046669999999999996, -0.04672, -0.047080000000000004, -0.04672, -0.04623, -0.047080000000000004, -0.047080000000000004, -0.04645, -0.046360000000000005, -0.04528, -0.04456, -0.04402, -0.04389, -0.04438, -0.04488, -0.04488, -0.04546, -0.04618, -0.04578, -0.04578, -0.04596, -0.045689999999999995, -0.0451, -0.04411, -0.04313, -0.042230000000000004, -0.0416, -0.04079, -0.03913, -0.037380000000000004, -0.03715, -0.0372, -0.03729, -0.03783, -0.03791, -0.036930000000000004, -0.0367, -0.03729, -0.03791, -0.03845, -0.038810000000000004, -0.039169999999999996, -0.039080000000000004, -0.03859, -0.03872, -0.03863, -0.03859, -0.03791, -0.0372, -0.03657, -0.03612, -0.0363, -0.03549, -0.034319999999999996, -0.03369, -0.03306, -0.03288, -0.031939999999999996, -0.03082, -0.029289999999999997, -0.028569999999999998, -0.02808, -0.02767, -0.026639999999999997, -0.02677, -0.02588, -0.02516, -0.02516, -0.02462, -0.023180000000000003, -0.02165, -0.02062, -0.02048, -0.02084, -0.0221, -0.02246, -0.02309, -0.0221, -0.020569999999999998, -0.0195, -0.01905, -0.01761, -0.01739, -0.016669999999999997, -0.01617, -0.01491, -0.01438, -0.015, -0.015719999999999998, -0.0159, -0.015, -0.01433, -0.01464, -0.01433, -0.014730000000000002, -0.01438, -0.0142, -0.01402, -0.0133, -0.01294, -0.012759999999999999, -0.01253, -0.01204, -0.01056, -0.01042, -0.00912, -0.007909999999999999, -0.0059299999999999995, -0.00449, -0.0036799999999999997, -0.0033200000000000005, -0.00216, -0.00126, 0.00031, 0.00126, 0.00288, 0.0043100000000000005, 0.00472, 0.00476, 0.00503, 0.0059299999999999995, 0.00584, 0.00584, 0.00611, 0.00629, 0.00683, 0.00782, 0.0088, 0.00975, 0.0115, 0.01384, 0.01563, 0.01779, 0.01851, 0.018869999999999998, 0.02022, 0.02102, 0.02192, 0.02174, 0.02327, 0.02426, 0.02534, 0.02659, 0.027939999999999996, 0.028569999999999998, 0.02947, 0.030369999999999998, 0.03145, 0.03315, 0.03522, 0.03841, 0.04178, 0.04519, 0.047619999999999996, 0.04861, 0.05081, 0.05148, 0.05292, 0.05499, 0.057139999999999996, 0.0584, 0.05822000000000001, 0.059210000000000006, 0.060379999999999996, 0.06217, 0.06325, 0.06496, 0.06729, 0.07026, 0.07197, 0.07385, 0.07529, 0.07672999999999999, 0.07835, 0.07942, 0.08148999999999999, 0.08275, 0.08347, 0.08275, 0.08266, 0.08238999999999999, 0.0832, 0.08428, 0.08562, 0.08728999999999999, 0.08787, 0.08877, 0.08985, 0.09021, 0.09128, 0.092, 0.09218, 0.09187000000000001, 0.09232, 0.09326, 0.09308, 0.09383999999999999, 0.09473999999999999, 0.09506, 0.09506, 0.09425, 0.09542, 0.09694, 0.09721, 0.09685, 0.09658, 0.09542, 0.09461, 0.09326, 0.09137, 0.08957999999999999, 0.0876, 0.08481, 0.08113, 0.07664, 0.07255, 0.06828, 0.06442, 0.059570000000000005, 0.05391, 0.04816, 0.04375, 0.03935, 0.03558, 0.031810000000000005, 0.02731, 0.02282, 0.018869999999999998, 0.015269999999999999, 0.0124, 0.00898, 0.0059299999999999995, 0.0027, -0.00103, -0.00409, -0.007409999999999999, -0.01042, -0.01366, -0.01671, -0.01977, -0.02336, -0.0274, -0.031089999999999996, -0.03342, -0.03576, -0.03791, -0.039580000000000004, -0.0425, -0.04456, -0.046360000000000005, -0.04721, -0.049010000000000005, -0.051570000000000005, -0.0535, -0.05499, -0.056060000000000006, -0.05602000000000001, -0.05624, -0.056060000000000006, -0.0566, -0.057229999999999996, -0.05876, -0.05948, -0.06056, -0.061989999999999996, -0.06325, -0.06397, -0.06415, -0.06451, -0.06631000000000001, -0.06604, -0.0659, -0.06631000000000001, -0.06532, -0.06451, -0.06361, -0.06298, -0.061989999999999996, -0.06092, -0.0611, -0.06092, -0.06118, -0.06163, -0.06145, -0.061720000000000004, -0.06092, -0.06015, -0.05993, -0.059660000000000005, -0.0593, -0.05876, -0.05795, -0.0584, -0.05894, -0.06056, -0.061360000000000005, -0.06065, -0.059660000000000005, -0.059660000000000005, -0.059660000000000005, -0.0593, -0.05795, -0.05678, -0.05534, -0.054720000000000005, -0.05463, -0.054270000000000006, -0.05359, -0.05301, -0.05314, -0.05292, -0.05292, -0.05256, -0.05189, -0.05085, -0.05045, -0.05013, -0.05022, -0.050089999999999996, -0.05013, -0.04995, -0.05004, -0.04906, -0.04924, -0.050089999999999996, -0.04942, -0.047439999999999996, -0.04614, -0.045239999999999995, -0.04438, -0.04349, -0.04268, -0.04295, -0.04322, -0.04268, -0.042589999999999996, -0.0425, -0.04313, -0.04438, -0.04456, -0.04492, -0.04492, -0.04456, -0.0434, -0.04313, -0.042769999999999996, -0.04187, -0.04061, -0.03998, -0.039310000000000005, -0.03922, -0.038810000000000004, -0.03845, -0.03818, -0.03863, -0.037739999999999996, -0.0363, -0.03621, -0.03639, -0.03648, -0.036969999999999996, -0.03765, -0.037739999999999996, -0.037380000000000004, -0.037380000000000004, -0.037689999999999994, -0.0372, -0.03612, -0.036660000000000005, -0.03639, -0.037380000000000004, -0.036789999999999996, -0.03648, -0.03648, -0.03589, -0.03369, -0.03333, -0.03252, -0.03145, -0.030189999999999998, -0.029110000000000004, -0.02785, -0.02817, -0.02947, -0.03055, -0.030910000000000003, -0.030189999999999998, -0.03055, -0.03127, -0.02965, -0.030010000000000002, -0.029830000000000002, -0.028210000000000002, -0.02767, -0.02866, -0.029019999999999997, -0.030010000000000002, -0.030910000000000003, -0.03046, -0.030189999999999998, -0.02947, -0.02767, -0.0265, -0.02677, -0.02677, -0.02677, -0.02695, -0.02565, -0.02444, -0.02394, -0.023, -0.02228, -0.023180000000000003, -0.02336, -0.02273, -0.02228, -0.02228, -0.023180000000000003, -0.023, -0.02134, -0.021830000000000002, -0.02156, -0.02174, -0.02084, -0.02084, -0.01986, -0.01905, -0.01896, -0.01905, -0.0186, -0.01797, -0.01725, -0.01644, -0.01617, -0.015719999999999998, -0.01563, -0.01545, -0.01581, -0.016309999999999998, -0.01761, -0.018009999999999998, -0.018330000000000003, -0.01761, -0.01635, -0.01563, -0.01518, -0.015090000000000001, -0.015090000000000001, -0.01563, -0.01545, -0.015269999999999999, -0.015359999999999999, -0.01563, -0.014730000000000002, -0.0142, -0.01325, -0.0124, -0.01132, -0.01199, -0.0124, -0.01222, -0.01285, -0.01316, -0.01213, -0.0111, -0.0106, -0.0106, -0.01096, -0.01105, -0.01069, -0.01006, -0.0097, -0.01006, -0.01087, -0.01119, -0.0119, -0.01375, -0.01438, -0.01491, -0.014819999999999998, -0.015359999999999999, -0.015269999999999999, -0.01617, -0.01626, -0.014730000000000002, -0.0133, -0.011859999999999999, -0.01006, -0.008, -0.00678, -0.00647, -0.00629, -0.00629, -0.00656, -0.00746, -0.00773, -0.0071400000000000005, -0.007909999999999999, -0.00898, -0.01006, -0.01168, -0.01168, -0.0115, -0.01078, -0.01078, -0.0115, -0.01204, -0.011859999999999999, -0.01078, -0.01105, -0.01069, -0.00979, -0.00831, -0.00692, -0.00575, -0.00575, -0.00539, -0.00548, -0.00485, -0.00404, -0.0044, -0.0046700000000000005, -0.00485, -0.00494, -0.0046700000000000005, -0.00521, -0.0054399999999999995, -0.0054399999999999995, -0.00512, -0.00485, -0.00548, -0.00503, -0.00548, -0.00602, -0.00629, -0.00575, -0.0046700000000000005, -0.0035, -0.0034100000000000003, -0.00279, -0.00323, -0.00395, -0.00386, -0.00445, -0.0053, -0.00548, -0.0046700000000000005, -0.00485, -0.00485, -0.00521, -0.00557, -0.00548, -0.0054399999999999995, -0.0058, -0.00732, -0.00836, -0.00867, -0.00898, -0.00921, -0.008579999999999999, -0.0075, -0.00782, -0.00719, -0.0066, -0.00647, -0.00562, -0.0059299999999999995, -0.0053, -0.00413, -0.00323, -0.0027, -0.00256, -0.00305, -0.0026100000000000003, -0.0026100000000000003, -0.00296, -0.0033200000000000005, -0.0035, -0.00395, -0.00395, -0.00391, -0.00305, -0.00359, -0.00314, -0.0034100000000000003, -0.00395, -0.0033200000000000005, -0.00305, -0.00359, -0.00395, -0.004220000000000001, -0.004220000000000001, -0.0046700000000000005, -0.00449, -0.0043100000000000005, -0.00512, -0.0053, -0.00629, -0.00818, -0.00952, -0.00988, -0.00988, -0.00952, -0.01006, -0.01042, -0.01123, -0.010920000000000001, -0.0115, -0.012759999999999999
    ));

    SignalDetector signalDetector = new SignalDetector();
    int lag = 30;
    double threshold = 5;
    double influence = 0;

    HashMap<String, List> resultsMap = signalDetector.analyzeDataForSignals(data, lag, threshold, influence);

    List<Integer> signalsList = resultsMap.get("signals");
    List<Double> filteredDataList = resultsMap.get("filteredData");



    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_monitor_heart_rate);
        Toolbar toolbar = (Toolbar) findViewById(R.id.heartratetoolbar);
        setSupportActionBar(toolbar);

        toolbar.setNavigationIcon(R.drawable.ic_back);

        toolbar.setNavigationOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                finish();
            }
        });

        TextView tv1 = (TextView)findViewById(R.id.alerta_heart);
        tv1.setText("Mostrar Alerta");

        TextView tv2 = (TextView)findViewById(R.id.medida_heart);
        tv2.setText("Midiendo");

        TextView tv3 = (TextView)findViewById(R.id.med_ppm);
        tv3.setText("ppm");


        final TextView textView = (TextView)findViewById(R.id.medida_heart);


        final TextView h1 = (TextView)findViewById(R.id.heart1);


        double valor = 0;
        int pulsaciones = 0;
        for (int i = 0; i < signalsList.size(); i++) {
            if (signalsList.get(i) != 0) {
                if (signalsList.get(i) != valor && signalsList.get(i) != -1){
                    valor = signalsList.get(i);
                    pulsaciones = pulsaciones + 1;//se halla peak
                }
                //System.out.println("Point " + i + " gave signal " + signalsList.get(i));
            }
        }
        System.out.println("CANTIDAD DE PULSACIONES ES" + pulsaciones);
        n = data.size();
        System.out.println("valor de n es " + n);
        Thread t=new Thread(){
            @Override
            public void run(){
                while(!isInterrupted()){
                    try {
                        Thread.sleep(1000);  //1000ms = 1 sec
                        runOnUiThread(new Runnable() {
                            @Override
                            public void run() {


                                count++;
                                textView.setText(String.valueOf(maxEle));
                                date = new Date();
                                dateformatted = dateFormat.format(date);
                                histroy_log = dateformatted + ": " + count + " ppm";
                                h1.setText(histroy_log);
                                try {
                                    OutputStreamWriter output = new OutputStreamWriter(openFileOutput("heart_rate_history.txt", Activity.MODE_APPEND));
                                    output.append(histroy_log+"\n");
                                    output.flush();
                                    output.close();
                                } catch (IOException e) {
                                }
                            }
                        });
                    }catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        };
        t.start();
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        int id = item.getItemId();
        switch (id) {
            // Respond to the action bar's Up/Home button
            case android.R.id.home:
                //NavUtils.navigateUpFromSameTask(this);
                onBackPressed();
                return true;
        }
        return super.onOptionsItemSelected(item);
    }

    public void viewHistory(View view){
        Intent viewHistoryIntent = new Intent(view.getContext(), checkHistory.class);
        viewHistoryIntent.putExtra("origin", "heartRate");
        startActivity(viewHistoryIntent);
    }
}